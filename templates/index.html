<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --success-color: #4ade80;
            --warning-color: #facc15;
            --danger-color: #f87171;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 15px 0;
        }
        
        .icon-wrapper {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            padding: 25px 15px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .feature-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 25px;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-3px);
        }
        
        .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.5rem;
            color: white;
        }
        
        .term-highlight {
            font-weight: 600;
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .explanation {
            background: rgba(67, 97, 238, 0.05);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: 0 10px 10px 0;
            margin: 25px 0;
        }
        
        .explanation h6 {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .progress-bar-custom {
            border-radius: 10px;
        }
        
        .footer {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 0;
            margin-top: 50px;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
            color: white;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stat-number {
                font-size: 1.8rem;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>ML Analysis Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#upload-section"><i class="fas fa-upload me-1"></i> Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#results-section"><i class="fas fa-chart-line me-1"></i> Results</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="container my-5">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-4">Machine Learning Analysis Dashboard</h1>
                <p class="lead mb-4">Analyze datasets, compare models, and visualize performance metrics with our intuitive platform.</p>
                <div class="d-grid gap-3 d-sm-flex justify-content-sm-start">
                    <button id="runAnalysisBtn" class="btn btn-custom btn-lg px-4 me-sm-3">
                        <i class="fas fa-play me-2"></i>Run Analysis
                    </button>
                    <a href="#upload-section" class="btn btn-outline-primary btn-lg px-4">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Upload Dataset
                    </a>
                </div>
            </div>
            <div class="col-lg-6 d-none d-lg-block">
                <div class="text-center">
                    <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" 
                         alt="ML Visualization" class="img-fluid rounded-3 shadow-lg" style="max-height: 400px; object-fit: cover;">
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="container my-5">
        <div class="row mb-5">
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <i class="fas fa-database fa-2x mb-3 text-primary"></i>
                    <div class="stat-number" id="datasetCount">0</div>
                    <div class="text-muted">Datasets</div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <i class="fas fa-chart-line fa-2x mb-3 text-success"></i>
                    <div class="stat-number" id="modelCount">0</div>
                    <div class="text-muted">Models</div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <i class="fas fa-tasks fa-2x mb-3 text-info"></i>
                    <div class="stat-number" id="analysisCount">0</div>
                    <div class="text-muted">Analyses</div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <i class="fas fa-users fa-2x mb-3 text-warning"></i>
                    <div class="stat-number" id="accuracyAvg">0%</div>
                    <div class="text-muted">Avg. Accuracy</div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row mb-5" id="upload-section">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h3 class="section-title mb-0">Upload Your Dataset</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6 mb-4 mb-lg-0">
                                <form id="uploadForm">
                                    <div class="mb-3">
                                        <label for="csvFile" class="form-label">Select CSV File</label>
                                        <input class="form-control" type="file" id="csvFile" accept=".csv" required>
                                    </div>
                                    <button type="submit" class="btn btn-custom w-100" id="uploadBtn">
                                        <i class="fas fa-cloud-upload-alt me-2"></i> Upload and Analyze
                                    </button>
                                </form>
                            </div>
                            <div class="col-lg-6">
                                <div class="feature-card h-100">
                                    <div class="feature-icon">
                                        <i class="fas fa-file-upload"></i>
                                    </div>
                                    <h5 class="fw-bold">Upload Guidelines</h5>
                                    <ul class="text-start text-muted mt-3" style="font-size: 0.9rem;">
                                        <li>Last column will be treated as target variable</li>
                                        <li>First row should contain column headers</li>
                                        <li>Minimum 2 columns required</li>
                                        <li>Supports numerical and categorical data</li>
                                        <li>Missing values will be automatically handled</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="uploadStatus" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="section-title">Dataset Overview</h3>
                <p class="text-muted mb-4">Explore preloaded datasets and your uploaded data</p>
            </div>
        </div>
        <div class="row" id="summaryCards">
            <!-- Cards will be populated by JavaScript -->
        </div>

        <!-- Model Comparison Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h3 class="section-title mb-0">Model Performance Comparison</h3>
                        <span class="badge bg-primary rounded-pill">Advanced Analytics</span>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">Compare the performance of different machine learning models across all datasets</p>
                        <div class="d-grid gap-2 d-md-block mb-4">
                            <button id="compareModelsBtn" class="btn btn-custom me-md-2 mb-2 mb-md-0">
                                <i class="fas fa-sync-alt me-1"></i> Refresh Comparison
                            </button>
                            <button id="toggleViewBtn" class="btn btn-outline-primary">
                                <i class="fas fa-th-large me-1"></i> Grid View
                            </button>
                        </div>
                        <div id="comparisonResults">
                            <!-- Comparison results will be loaded here -->
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading comparison...</span>
                                </div>
                                <p class="mt-3">Click "Refresh Comparison" to load model performance data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row mt-5" id="results-section">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="section-title mb-0">Analysis Results</h3>
                        <p class="text-muted mb-0">Comprehensive insights from all machine learning analyses</p>
                    </div>
                    <div>
                        <button id="toggleViewBtn" class="btn btn-outline-primary">
                            <i class="fas fa-th-large me-1"></i> Grid View
                        </button>
                    </div>
                </div>
                <div id="resultsContainer">
                    <!-- Results will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading results...</span>
                        </div>
                        <p class="mt-3">Loading analysis results...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // Global variables
        let currentData = {};
        let gridView = true; // Toggle between grid and list view
        
        // Fetch and display results
        async function fetchResults() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                currentData = data;
                
                // Update stats
                updateStats(data);
                
                // Update summary cards
                updateSummaryCards(data);
                
                // Display results
                displayResults(data);
                
                console.log('Results fetched:', data);
            } catch (error) {
                console.error('Error fetching results:', error);
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading results: ${error.message}
                    </div>
                `;
            }
        }
        
        // Update statistics
        function updateStats(data) {
            const datasetCount = Object.keys(data).length;
            let modelCount = 0;
            let totalAccuracy = 0;
            let accuracyCount = 0;
            
            Object.values(data).forEach(dataset => {
                if (dataset.results) {
                    modelCount += Object.keys(dataset.results).length;
                    // For classification datasets, accumulate accuracy
                    if (dataset.results.accuracy !== undefined) {
                        totalAccuracy += dataset.results.accuracy;
                        accuracyCount++;
                    } else {
                        // For datasets with multiple models, check each model's results
                        Object.values(dataset.results).forEach(modelResult => {
                            if (modelResult.accuracy !== undefined) {
                                totalAccuracy += modelResult.accuracy;
                                accuracyCount++;
                            }
                        });
                    }
                }
            });
            
            document.getElementById('datasetCount').textContent = datasetCount;
            document.getElementById('modelCount').textContent = modelCount;
            document.getElementById('analysisCount').textContent = datasetCount;
            
            if (accuracyCount > 0) {
                const avgAccuracy = (totalAccuracy / accuracyCount * 100).toFixed(1);
                document.getElementById('accuracyAvg').textContent = `${avgAccuracy}%`;
            } else {
                document.getElementById('accuracyAvg').textContent = '0%';
            }
        }
        
        // Update summary cards
        function updateSummaryCards(data) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            const summaries = [
                { id: 'iris', title: 'Iris Classification', icon: 'seedling', color: '#28a745' },
                { id: 'titanic', title: 'Titanic Survival', icon: 'ship', color: '#17a2b8' },
                { id: 'imdb', title: 'IMDb Sentiment', icon: 'film', color: '#ffc107' },
                { id: 'kmeans', title: 'K-Means Clustering', icon: 'chart-pie', color: '#6f42c1' }
            ];
            
            let hasPredefinedDatasets = false;
            let hasUploadedDatasets = false;
            
            // Add predefined datasets
            summaries.forEach(summary => {
                if (data[summary.id]) {
                    hasPredefinedDatasets = true;
                    const col = document.createElement('div');
                    col.className = 'col-xl-3 col-md-6 mb-4 fade-in';
                    col.innerHTML = `
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body metric-card">
                                <div class="icon-wrapper mb-3" style="background: linear-gradient(135deg, ${summary.color} 0%, #2575fc 100%);">
                                    <i class="fas fa-${summary.icon}"></i>
                                </div>
                                <h5 class="card-title fw-bold">${summary.title}</h5>
                                <div class="metric-value">
                                    ${data[summary.id].dataset_shape ? data[summary.id].dataset_shape[0] : 'N/A'}
                                </div>
                                <p class="text-muted mb-3">samples</p>
                                <a href="/results/${summary.id}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            });
            
            // Add uploaded datasets
            Object.keys(data).forEach(key => {
                if (key.startsWith('upload_')) {
                    hasUploadedDatasets = true;
                    const dataset = data[key];
                    const datasetName = key.replace('upload_', '');
                    const col = document.createElement('div');
                    col.className = 'col-xl-3 col-md-6 mb-4 fade-in';
                    col.innerHTML = `
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body metric-card">
                                <div class="icon-wrapper mb-3" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);">
                                    <i class="fas fa-file-csv"></i>
                                </div>
                                <h5 class="card-title fw-bold">${dataset.name.replace(' Analysis', '')}</h5>
                                <div class="metric-value">
                                    ${dataset.dataset_shape ? dataset.dataset_shape[0] : 'N/A'}
                                </div>
                                <p class="text-muted mb-3">samples</p>
                                <div class="d-grid gap-2">
                                    <a href="/results/${key}" class="btn btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i> View Details
                                    </a>
                                    <button class="btn btn-outline-danger delete-dataset-btn" data-dataset="${datasetName}">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            });
            
            // Show message if no datasets
            if (!hasPredefinedDatasets && !hasUploadedDatasets) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-database fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No datasets available</h5>
                            <p class="text-muted">Upload a dataset or run analysis to see results</p>
                        </div>
                    </div>
                `;
            }
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-dataset-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const datasetName = this.getAttribute('data-dataset');
                    deleteDataset(datasetName);
                });
            });
        }
        
        // Display detailed results
        function displayResults(data) {
            let html = '';
            
            if (gridView) {
                html = '<div class="row">';
                
                Object.keys(data).forEach(key => {
                    // Skip uploaded datasets in the main results view to avoid duplication
                    if (key.startsWith('upload_')) return;
                    
                    const analysis = data[key];
                    html += `
                        <div class="col-xl-4 col-md-6 mb-4 fade-in">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0">${analysis.name}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <span class="badge bg-light text-dark me-2">
                                            <i class="fas fa-table me-1"></i> ${analysis.dataset_shape[0]} × ${analysis.dataset_shape[1]}
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-code-branch me-1"></i> ${Object.keys(analysis.results || {}).length} Models
                                        </span>
                                    </div>
                                    ${renderAnalysisResults(analysis.results)}
                                    <a href="/results/${key}" class="btn btn-outline-primary w-100 mt-3">
                                        <i class="fas fa-chart-line me-1"></i> Detailed View
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add uploaded datasets separately
                Object.keys(data).forEach(key => {
                    if (key.startsWith('upload_')) {
                        const analysis = data[key];
                        const datasetName = key.replace('upload_', '');
                        html += `
                            <div class="col-xl-4 col-md-6 mb-4 fade-in">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-header bg-white py-3">
                                        <h5 class="mb-0">${analysis.name.replace(' Analysis', '')} <span class="badge bg-success">Uploaded</span></h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <span class="badge bg-light text-dark me-2">
                                                <i class="fas fa-table me-1"></i> ${analysis.dataset_shape[0]} × ${analysis.dataset_shape[1]}
                                            </span>
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-code-branch me-1"></i> ${Object.keys(analysis.results || {}).length} Models
                                            </span>
                                        </div>
                                        ${renderAnalysisResults(analysis.results)}
                                        <div class="d-grid gap-2 mt-3">
                                            <a href="/results/${key}" class="btn btn-outline-primary">
                                                <i class="fas fa-chart-line me-1"></i> Detailed View
                                            </a>
                                            <button class="btn btn-outline-danger delete-dataset-btn" data-dataset="${datasetName}">
                                                <i class="fas fa-trash me-1"></i> Delete Dataset
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
            } else {
                // List view
                html = '<div class="list-group">';
                
                Object.keys(data).forEach(key => {
                    const analysis = data[key];
                    const displayName = analysis.name;
                    const isUploaded = key.startsWith('upload_');
                    const datasetName = isUploaded ? key.replace('upload_', '') : null;
                    
                    html += `
                        <div class="list-group-item list-group-item-action p-4 mb-3 border-0 shadow-sm rounded-3">
                            <div class="d-flex w-100 justify-content-between mb-3">
                                <h5 class="mb-1">${displayName} ${isUploaded ? '<span class="badge bg-success ms-2">Uploaded</span>' : ''}</h5>
                                <small class="text-muted">
                                    <i class="fas fa-table me-1"></i> ${analysis.dataset_shape[0]} × ${analysis.dataset_shape[1]}
                                </small>
                            </div>
                            <div class="mb-3">
                                ${renderAnalysisResults(analysis.results)}
                            </div>
                            <div class="d-grid gap-2 d-md-block">
                                <a href="/results/${key}" class="btn btn-outline-primary me-md-2">
                                    <i class="fas fa-chart-line me-1"></i> Detailed View
                                </a>
                                ${isUploaded ? `<button class="btn btn-outline-danger delete-dataset-btn" data-dataset="${datasetName}">
                                    <i class="fas fa-trash me-1"></i> Delete Dataset
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
            
            // Re-initialize tooltips
            setTimeout(initializeTooltips, 100);
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-dataset-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const datasetName = this.getAttribute('data-dataset');
                    deleteDataset(datasetName);
                });
            });
        }
        
        // Render analysis results
        function renderAnalysisResults(results) {
            if (!results) return '<p class="text-muted">No results available</p>';
            
            // Check if this is sentiment analysis (IMDb)
            if (results.accuracy !== undefined) {
                const accuracy = results.accuracy;
                const f1Score = results['1'] ? results['1']['f1-score'] : 0;
                
                return `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <strong>Accuracy</strong>
                            <span>${(accuracy * 100).toFixed(1)}%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-custom bg-success" role="progressbar" 
                                 style="width: ${(accuracy * 100)}%" 
                                 aria-valuenow="${(accuracy * 100)}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <strong>F1-Score</strong>
                            <span>${f1Score.toFixed(3)}</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-custom bg-info" role="progressbar" 
                                 style="width: ${(f1Score * 100)}%" 
                                 aria-valuenow="${(f1Score * 100)}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;
            }
            
            // Check if this is regression results
            if (results && Object.keys(results).length > 0 && results[Object.keys(results)[0]] && results[Object.keys(results)[0]].hasOwnProperty('mse')) {
                let html = '<div class="row">';
                let hasResults = false;
                
                Object.keys(results).forEach(model => {
                    const metrics = results[model];
                    if (metrics && metrics.hasOwnProperty('mse')) {
                        hasResults = true;
                        const mse = metrics['mse'];
                        const rmse = metrics['rmse'];
                        const r2 = metrics['r2'];
                        
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="border rounded p-3">
                                    <h6 class="text-center mb-3">${model}</h6>
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>R² Score</span>
                                            <span>${r2.toFixed(4)}</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-bar-custom bg-success" role="progressbar" 
                                                 style="width: ${(r2 * 100)}%" 
                                                 aria-valuenow="${(r2 * 100)}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                
                if (!hasResults) {
                    html = '<p class="text-muted">No valid regression results to display</p>';
                }
                
                return html;
            }
            
            // Otherwise, treat as classification results
            let html = '<div class="row">';
            let hasResults = false;
            
            Object.keys(results).forEach(model => {
                const metrics = results[model];
                if (metrics && metrics.hasOwnProperty('accuracy')) {
                    hasResults = true;
                    const accuracy = metrics.accuracy;
                    const weightedMetrics = metrics['weighted avg'] || {};
                    const precision = weightedMetrics.precision || 0;
                    const recall = weightedMetrics.recall || 0;
                    const f1Score = weightedMetrics['f1-score'] || 0;
                    
                    html += `
                        <div class="col-md-6 col-xl-4 mb-3">
                            <div class="border rounded p-3">
                                <h6 class="text-center mb-3">${model}</h6>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Accuracy</span>
                                        <span>${(accuracy * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar progress-bar-custom bg-success" role="progressbar" 
                                             style="width: ${(accuracy * 100)}%" 
                                             aria-valuenow="${(accuracy * 100)}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>F1-Score</span>
                                        <span>${f1Score.toFixed(3)}</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar progress-bar-custom bg-info" role="progressbar" 
                                             style="width: ${(f1Score * 100)}%" 
                                             aria-valuenow="${(f1Score * 100)}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            if (!hasResults) {
                html = '<p class="text-muted">No valid results to display</p>';
            } else {
                html += `
                    <div class="explanation">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong class="text-primary">Understanding Metrics</strong>
                            <i class="fas fa-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               title="Accuracy: Percentage of correct predictions. F1-Score: Balance of precision and recall."></i>
                        </div>
                        <p class="mb-0 mt-2">Higher values indicate better model performance.</p>
                        <h6 class="mt-3 mb-2">Simple Explanations</h6>
                        <ul class="mb-0">
                            <li><span class="term-highlight">Accuracy</span>: How often the model is correct overall</li>
                            <li><span class="term-highlight">Precision</span>: When it predicts "Yes", how often is it right?</li>
                            <li><span class="term-highlight">Recall</span>: Of all actual "Yes" cases, how many did it catch?</li>
                            <li><span class="term-highlight">F1-Score</span>: A balance of precision and recall</li>
                        </ul>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Compare models across datasets
        async function compareModels() {
            try {
                const response = await fetch('/api/compare-models');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to compare models');
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Model</th>
                `;
                
                // Add dataset columns
                result.datasets.forEach(dataset => {
                    html += `<th>${dataset}</th>`;
                });
                
                html += `
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add model rows
                Object.keys(result.comparisons.model_accuracy).forEach(model => {
                    html += `<tr><td><strong>${model}</strong></td>`;
                    
                    result.datasets.forEach(dataset => {
                        const accuracy = result.comparisons.model_accuracy[model][dataset] || 0;
                        
                        // Determine metric type and formatting based on model name and dataset
                        let displayValue = `${accuracy.toFixed(2)}%`;
                        let valueClass = 'text-muted';
                        
                        // Determine color based on value (green for high, red for low)
                        if (accuracy >= 90) {
                            valueClass = 'text-success';
                        } else if (accuracy >= 80) {
                            valueClass = 'text-primary';
                        } else if (accuracy >= 70) {
                            valueClass = 'text-warning';
                        } else if (accuracy > 0) {
                            valueClass = 'text-danger';
                        }
                        
                        // Special handling for regression models (R² score) - higher is better
                        // For classification models (accuracy) - higher is better
                        html += `<td class="${valueClass}"><strong>${displayValue}</strong></td>`;
                    });
                    html += '</tr>';
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="explanation">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Understanding Model Comparison</h6>
                            <i class="fas fa-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               title="Comparison of model performance across datasets"></i>
                        </div>
                        <p>Higher percentages indicate better model performance on each dataset.</p>
                        <ul>
                            <li><span class="term-highlight">Green values (90%+)</span>: Excellent performance</li>
                            <li><span class="term-highlight">Blue values (80-89%)</span>: Good performance</li>
                            <li><span class="term-highlight">Yellow values (70-79%)</span>: Fair performance</li>
                            <li><span class="term-highlight">Red values (below 70%)</span>: Poor performance</li>
                        </ul>
                        <h6 class="mt-3 mb-2">Simple Explanations for ML Metrics</h6>
                        <ul>
                            <li><span class="term-highlight">Accuracy</span>: The percentage of correct predictions. If accuracy is 85%, the model got 85 out of 100 predictions right.</li>
                            <li><span class="term-highlight">Precision</span>: When the model predicts something is positive, precision tells you how often it's correct. High precision means fewer false alarms.</li>
                            <li><span class="term-highlight">Recall</span>: Out of all items that truly belong to a category, recall tells you what percentage the model found. High recall means the model misses fewer items.</li>
                            <li><span class="term-highlight">F1-Score</span>: A balanced score that considers both precision and recall. It's especially useful when you care about both finding most items AND being accurate about what you find.</li>
                        </ul>
                    </div>
                `;
                
                document.getElementById('comparisonResults').innerHTML = html;
                
                // Re-initialize tooltips
                setTimeout(initializeTooltips, 100);
            } catch (error) {
                console.error('Error comparing models:', error);
                document.getElementById('comparisonResults').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error comparing models: ${error.message}
                    </div>
                `;
            }
        }
        
        // Run analysis
        async function runAnalysis() {
            try {
                document.getElementById('runAnalysisBtn').disabled = true;
                document.getElementById('runAnalysisBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Running Analysis...';
                
                const response = await fetch('/api/run-analysis', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Refresh results
                    await fetchResults();
                    showNotification('Analysis completed successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to run analysis');
                }
            } catch (error) {
                console.error('Error running analysis:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            } finally {
                document.getElementById('runAnalysisBtn').disabled = false;
                document.getElementById('runAnalysisBtn').innerHTML = '<i class="fas fa-play me-2"></i>Run Analysis';
            }
        }
        
        // Handle file upload
        async function handleFileUpload(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to upload', 'warning');
                return;
            }
            
            if (!file.name.endsWith('.csv')) {
                showNotification('Please upload a CSV file', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Uploading...';
                
                const response = await fetch('/api/upload-dataset', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Reset form
                    document.getElementById('uploadForm').reset();
                    
                    // Refresh results
                    await fetchResults();
                    
                    showNotification(result.message || 'Dataset uploaded and analyzed successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to upload dataset');
                }
            } catch (error) {
                console.error('Error uploading dataset:', error);
                showNotification(`Upload failed: ${error.message}`, 'danger');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i> Upload and Analyze';
            }
        }
        
        // Delete dataset
        async function deleteDataset(datasetName) {
            if (!confirm(`Are you sure you want to delete the dataset "${datasetName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete-dataset/${datasetName}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Refresh results
                    await fetchResults();
                    showNotification(result.message || 'Dataset deleted successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to delete dataset');
                }
            } catch (error) {
                console.error('Error deleting dataset:', error);
                showNotification(`Delete failed: ${error.message}`, 'danger');
            }
        }
        
        // Toggle view (grid/list)
        function toggleView() {
            gridView = !gridView;
            const button = document.getElementById('toggleViewBtn');
            button.innerHTML = gridView ? 
                '<i class="fas fa-list me-1"></i> List View' : 
                '<i class="fas fa-th-large me-1"></i> Grid View';
            displayResults(currentData);
        }
        
        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            notification.innerHTML = `
                ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : 
                  type === 'danger' ? '<i class="fas fa-exclamation-triangle me-2"></i>' : 
                  type === 'warning' ? '<i class="fas fa-exclamation-circle me-2"></i>' : 
                  '<i class="fas fa-info-circle me-2"></i>'}
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Initialize tooltips
        function initializeTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            fetchResults();
            // Initialize tooltips after a short delay to ensure DOM is fully loaded
            setTimeout(initializeTooltips, 500);
            
            // Event listeners
            document.getElementById('runAnalysisBtn').addEventListener('click', runAnalysis);
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
            document.getElementById('compareModelsBtn').addEventListener('click', compareModels);
            document.getElementById('toggleViewBtn').addEventListener('click', toggleView);
        });
    </script>
    
    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-brain me-2"></i>ML Analysis Dashboard</h5>
                    <p class="text-light">Advanced machine learning analysis platform for comparing models and datasets.</p>
                </div>
                <div class="col-md-3">
                    <h5>Features</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check-circle me-2"></i> Model Comparison</li>
                        <li><i class="fas fa-check-circle me-2"></i> Dataset Analysis</li>
                        <li><i class="fas fa-check-circle me-2"></i> Performance Metrics</li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Resources</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-book me-2"></i> Documentation</li>
                        <li><i class="fas fa-question-circle me-2"></i> Help Center</li>
                        <li><i class="fas fa-envelope me-2"></i> Support</li>
                    </ul>
                </div>
            </div>
            <hr class="bg-light">
            <div class="text-center">
                <p class="mb-0">&copy; 2023 ML Analysis Dashboard. All rights reserved.</p>
            </div>
        </div>
    </div>
</body>
</html>