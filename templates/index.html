<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .btn-run-analysis {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            padding: 10px 20px;
        }
        .explanation {
            background-color: #e9ecef;
            border-left: 3px solid #0d6efd;
            padding: 8px;
            margin: 5px 0;
            border-radius: 0 3px 3px 0;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header text-center">
            <h1>Machine Learning Analysis Dashboard</h1>
            <p class="lead">Compare results across multiple datasets and algorithms</p>
            <button id="runAnalysisBtn" class="btn btn-light btn-run-analysis">
                <i class="fas fa-play-circle"></i> Run Analysis
            </button>
        </div>

        <!-- File Upload Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Upload Your Dataset</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Select CSV File</label>
                                <input class="form-control" type="file" id="csvFile" name="file" accept=".csv">
                            </div>
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="fas fa-upload"></i> Upload and Analyze
                            </button>
                        </form>
                        <div id="uploadStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row" id="summaryCards">
            <!-- Cards will be populated by JavaScript -->
        </div>

        <!-- Model Comparison Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Model Comparison</h2>
                    </div>
                    <div class="card-body">
                        <button id="compareModelsBtn" class="btn btn-secondary mb-3">
                            <i class="fas fa-chart-bar"></i> Compare Models Across Datasets
                        </button>
                        <div id="comparisonResults">
                            <p class="text-muted">Click the button above to compare model performances across all datasets.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Results Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h2>Analysis Results</h2>
                <div id="resultsContainer">
                    <!-- Results will be loaded here -->
                    <div class="text-center">
                        <p>Loading results...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // Fetch and display results
        async function fetchResults() {
            try {
                const response = await fetch('/api/results');
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', text);
                    throw new Error('Response is not JSON');
                }
                
                const data = await response.json();
                
                // Update summary cards
                updateSummaryCards(data);
                
                // Display detailed results
                displayResults(data);
            } catch (error) {
                console.error('Error fetching results:', error);
                document.getElementById('resultsContainer').innerHTML = 
                    '<div class="alert alert-danger">Error loading results: ' + error.message + '</div>';
            }
        }

        // Update summary cards
        function updateSummaryCards(data) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            const summaries = [
                { id: 'iris', title: 'Iris Classification', icon: 'flower' },
                { id: 'titanic', title: 'Titanic Survival', icon: 'ship' },
                { id: 'imdb', title: 'IMDb Sentiment', icon: 'film' },
                { id: 'kmeans', title: 'K-Means Clustering', icon: 'chart-bar' }
            ];
            
            // Add predefined datasets
            summaries.forEach(summary => {
                if (data[summary.id]) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3';
                    col.innerHTML = `
                        <div class="card">
                            <div class="card-body metric-card">
                                <i class="fas fa-${summary.icon} fa-2x mb-3"></i>
                                <h5 class="card-title">${summary.title}</h5>
                                <div class="metric-value">
                                    ${data[summary.id].dataset_shape ? data[summary.id].dataset_shape[0] : 'N/A'}
                                </div>
                                <p class="text-muted">samples 
                                    <i class="fas fa-info-circle text-primary" 
                                       data-bs-toggle="tooltip" 
                                       title="Number of data samples in this dataset."></i>
                                </p>
                                <a href="/results/${summary.id}" class="btn btn-primary btn-sm">View Details</a>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            });
            
            // Add uploaded datasets
            Object.keys(data).forEach(key => {
                if (key.startsWith('upload_')) {
                    const dataset = data[key];
                    const col = document.createElement('div');
                    col.className = 'col-md-3';
                    col.innerHTML = `
                        <div class="card">
                            <div class="card-body metric-card">
                                <i class="fas fa-file-csv fa-2x mb-3"></i>
                                <h5 class="card-title">${dataset.name}</h5>
                                <div class="metric-value">
                                    ${dataset.dataset_shape ? dataset.dataset_shape[0] : 'N/A'}
                                </div>
                                <p class="text-muted">samples 
                                    <i class="fas fa-info-circle text-primary" 
                                       data-bs-toggle="tooltip" 
                                       title="Number of data samples in this dataset."></i>
                                </p>
                                <a href="/results/${key}" class="btn btn-primary btn-sm">View Details</a>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            });
        }

        // Display detailed results
        function displayResults(data) {
            let html = '<div class="row">';
            
            Object.keys(data).forEach(key => {
                // Skip uploaded datasets in the main results view to avoid duplication
                if (key.startsWith('upload_')) return;
                
                const analysis = data[key];
                html += `
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>${analysis.name}</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Dataset Size:</strong> ${analysis.dataset_shape[0]} rows × ${analysis.dataset_shape[1]} columns</p>
                                ${renderAnalysisResults(analysis.results)}
                                <a href="/results/${key}" class="btn btn-outline-primary">Detailed View</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add uploaded datasets separately
            Object.keys(data).forEach(key => {
                if (key.startsWith('upload_')) {
                    const analysis = data[key];
                    html += `
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>${analysis.name} (Uploaded)</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Dataset Size:</strong> ${analysis.dataset_shape[0]} rows × ${analysis.dataset_shape[1]} columns</p>
                                    ${renderAnalysisResults(analysis.results)}
                                    <a href="/results/${key}" class="btn btn-outline-primary">Detailed View</a>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            document.getElementById('resultsContainer').innerHTML = html;
        }

        // Render analysis results
        function renderAnalysisResults(results) {
            if (!results) return '<p>No results available</p>';
            
            let html = '<div class="mt-3">';
            
            // Handle different result types
            if (results['silhouette_score']) {
                // K-means clustering results
                html += `<p><strong>Silhouette Score:</strong> ${results['silhouette_score'].toFixed(3)}</p>`;
                html += `<div class="explanation" style="font-size: 0.85em; padding: 8px; margin-top: 5px;">`;
                html += `Measures clustering quality (-1 to 1). Higher is better.`;
                html += `</div>`;
            } else if (results['accuracy']) {
                // Sentiment analysis results
                html += `<p><strong>Accuracy:</strong> ${(results['accuracy'] * 100).toFixed(2)}%</p>`;
                html += `<div class="explanation" style="font-size: 0.85em; padding: 8px; margin-top: 5px;">`;
                html += `Percentage of correct predictions. Higher is better.`;
                html += `</div>`;
            } else {
                // Classification results
                Object.keys(results).forEach(model => {
                    const metrics = results[model];
                    if (metrics && metrics['accuracy']) {
                        html += `<p><strong>${model} Accuracy:</strong> ${(metrics['accuracy'] * 100).toFixed(2)}%</p>`;
                        html += `<div class="explanation" style="font-size: 0.85em; padding: 8px; margin-top: 5px;">`;
                        html += `Correct predictions percentage. Higher is better.`;
                        html += `</div>`;
                    }
                });
            }
            
            html += '</div>';
            return html;
        }

        // Run analysis
        document.getElementById('runAnalysisBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';
            
            try {
                const response = await fetch('/api/run-analysis', {
                    method: 'POST'
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', text);
                    throw new Error('Response is not JSON');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    fetchResults(); // Refresh results
                } else {
                    alert('Analysis failed to run');
                }
            } catch (error) {
                console.error('Error running analysis:', error);
                alert('Error running analysis: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-play-circle"></i> Run Analysis';
            }
        });

        // Handle file upload
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (!fileInput.files.length) {
                uploadStatus.innerHTML = '<div class="alert alert-warning">Please select a file to upload.</div>';
                return;
            }
            
            const file = fileInput.files[0];
            console.log('Selected file:', file);
            
            if (!file.name.endsWith('.csv')) {
                uploadStatus.innerHTML = '<div class="alert alert-warning">Please select a CSV file.</div>';
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                console.log('Sending upload request');
                const response = await fetch('/api/upload-dataset', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Received response:', response);
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const contentType = response.headers.get('content-type');
                console.log('Response content-type:', contentType);
                
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', text);
                    throw new Error('Response is not JSON');
                }
                
                const result = await response.json();
                console.log('Parsed JSON result:', result);
                
                if (result.success) {
                    uploadStatus.innerHTML = '<div class="alert alert-success">File uploaded and analyzed successfully!</div>';
                    fetchResults(); // Refresh results to show the new dataset
                } else {
                    uploadStatus.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                uploadStatus.innerHTML = `<div class="alert alert-danger">Error uploading file: ${error.message}</div>`;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload and Analyze';
            }
        });

        // Handle model comparison
        document.getElementById('compareModelsBtn').addEventListener('click', async function() {
            const compareBtn = document.getElementById('compareModelsBtn');
            const comparisonResults = document.getElementById('comparisonResults');
            
            compareBtn.disabled = true;
            compareBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Comparing Models...';
            
            try {
                const response = await fetch('/api/compare-models');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', text);
                    throw new Error('Response is not JSON');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Display comparison results
                    let html = '<div class="table-responsive"><table class="table table-striped table-bordered">';
                    
                    // Create header row with dataset names
                    html += '<thead><tr><th>Model</th>';
                    result.datasets.forEach(dataset => {
                        html += `<th>${dataset}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    // Create rows for each model
                    Object.keys(result.comparisons.model_accuracy).forEach(model => {
                        html += `<tr><td><strong>${model}</strong></td>`;
                        result.datasets.forEach(dataset => {
                            const accuracy = result.comparisons.model_accuracy[model][dataset] || 0;
                            html += `<td>${accuracy.toFixed(2)}%</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    comparisonResults.innerHTML = html;
                } else {
                    comparisonResults.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Error comparing models:', error);
                comparisonResults.innerHTML = `<div class="alert alert-danger">Error comparing models: ${error.message}</div>`;
            } finally {
                compareBtn.disabled = false;
                compareBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Compare Models Across Datasets';
            }
        });

        // Initialize tooltips
        function initializeTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            fetchResults();
            // Initialize tooltips after a short delay to ensure DOM is fully loaded
            setTimeout(initializeTooltips, 500);
        });
    </script>
</body>
</html>